<!DOCTYPE html>
<html lang="en" style="font-size: 10px; font-family: Roboto, Arial, sans-serif; background-color: #FAFAFA">
<head>
    <meta charset="UTF-8">
    <title>V-Image</title>
    <script src="../js/jquery-3.3.1.js"></script>
    <script src="../js/common.js"></script>
</head>
<link rel="stylesheet" type="text/css" href="../css/index.css">
<body>

<table align="center" width="1200px" border="0px">
    <tr>

        <td>
            <div style="display: flex; background: #FAFAFA">
                <img src="../img/logo.png" width="160px" height="80px" style="cursor: pointer">

                <div style="display: block; line-height: 80px">
                    <span style="font-size: 2em; color: #F44336; margin-left: 20px"><b>图集</b></span>
                    <span class="nav-title" onclick="window.open('./tag-management.html');">标签管理</span>
                    <span class="nav-title" onclick="window.open('./res-management.html');">资源管理</span>
                    <span class="nav-title" onclick="window.open('./index.html');">视频</span>
                </div>
            </div>
        </td>
    </tr>
    <tr>
        <td>
            <div id="album-image-list" style="position: absolute">
            </div>
        </td>
    </tr>
</table>

<div id="image-preview-container" style="position:fixed; left: 0; top: 0"></div>
</body>

<script>

    var RELATIVE_PATH_PREFIX = "../../";

    var imageList = [];
    var imageThumbnailList = [];
    var imageAlbumName;
    var imagePreviewIndex = -1;
    var IMAGE_COLUMN = 10;

    function queryAlbumDetail(name) {
        $.ajax({
            crossDomain: true,
            url: "http://localhost:8880/information",
            data: {type: "image-album-detail", album_name: name},
            method: "GET",
            dataType: "json",
            success: function (data) {
                if (data.code == 0 && data.data != null) {
                    console.log(data);
                    imageAlbumName = data.data.name;
                    {
                        imageList = [];
                        imageThumbnailList = [];

                        var extension = data.data.extension;
                        for (var i = 0; i < data.data.count; i++) {
                            imageList[imageList.length] = data.data.path + (data.data.base_index + i) + "." + extension;
                            imageThumbnailList[imageThumbnailList.length] = data.data.thumbnail_path + (data.data.base_index + i) + "." + extension;
                        }
                    }

                    updateAlbumImageList();
                }
            }
        });
    }

    function updateAlbumImageList() {

        var div = ``;
        for (var i = 0; i < imageThumbnailList.length; i++) {
            div = div + `
            <img src="${RELATIVE_PATH_PREFIX + imageThumbnailList[i]}" style="height: 116px; width: 116px; object-fit: cover; cursor: pointer; border-radius: 4px; position: absolute; left: ${120 * (i % IMAGE_COLUMN)}px; top: ${120 * Math.floor(i / IMAGE_COLUMN)}px" onclick="showImage(${i})" />
            `;
        }

        var i = imageList.length;
        div = div + `<img src="../img/playing.png" style="background: hsla(0, 0%, 10%, 0.8); height: 116px; width: 116px; object-fit: none; cursor: pointer; border-radius: 4px; position: absolute; left: ${120 * (i % IMAGE_COLUMN)}px; top: ${120 * Math.floor(i / IMAGE_COLUMN)}px; visibility: hidden" id="peview-img-cover" />`;

        document.getElementById("album-image-list").innerHTML = div;
    }

    function dismissImagePreview() {
        document.getElementById("image-preview-container").innerHTML = ``;
        document.getElementById("peview-img-cover").style.visibility = "hidden";
    }

    function showImagePreview() {
        console.log(imagePreviewIndex);
        document.getElementById("image-preview-container").innerHTML = `
        <img style="width: ${window.innerWidth}px; height: ${window.innerHeight}px; object-fit: contain; background: hsla(0, 0%, 10%, 0.8)" src="${RELATIVE_PATH_PREFIX + imageList[imagePreviewIndex]}" onclick="dismissImagePreview()" />
        <div style="position: fixed; right: 16px; bottom: 16px; font-size: 2em; text-align: center" class="tag-unselected tag-bg">${imagePreviewIndex + 1} / ${imageList.length}</div>
        `;

        var previewImgCover = document.getElementById("peview-img-cover");
        previewImgCover.style.visibility = "visible";
        previewImgCover.style.left = (120 * (imagePreviewIndex % IMAGE_COLUMN)) + "px";
        previewImgCover.style.top = (120 * Math.floor(imagePreviewIndex / IMAGE_COLUMN)) + "px";

        window.scrollTo(0, 120 * Math.floor(imagePreviewIndex / IMAGE_COLUMN));
    }

    function showImage(index) {
        console.log(index);
        imagePreviewIndex = index;
        showImagePreview();
    }

    function previewLeft() {
        if (imagePreviewIndex == 0) {
            imagePreviewIndex = imageList.length - 1;
        } else {
            imagePreviewIndex--;
        }
        showImagePreview();
    }

    function previewRight() {
        if (imagePreviewIndex == imageList.length - 1) {
            imagePreviewIndex = 0;
        } else {
            imagePreviewIndex++;
        }
        showImagePreview();
    }

    function previewUp() {
        if (imagePreviewIndex < IMAGE_COLUMN) {
            if (imagePreviewIndex % 10 == 0) {
                imagePreviewIndex = Math.floor(imageList.length / IMAGE_COLUMN) * IMAGE_COLUMN - 1;
            } else {
                imagePreviewIndex = Math.floor(imageList.length / IMAGE_COLUMN) * IMAGE_COLUMN + (imagePreviewIndex % IMAGE_COLUMN) - 1;
                while (imagePreviewIndex >= imageList.length) {
                    imagePreviewIndex -= IMAGE_COLUMN;
                }
            }
        } else {
            imagePreviewIndex -= IMAGE_COLUMN;
        }
        showImagePreview();
    }

    function previewDown() {
        if (imagePreviewIndex + IMAGE_COLUMN >= imageList.length) {
            if (imagePreviewIndex % 10 == 9) {
                imagePreviewIndex = 0;
            } else {
                imagePreviewIndex = (imagePreviewIndex % 10) + 1;
            }
        } else {
            imagePreviewIndex += IMAGE_COLUMN;
        }
        showImagePreview();
    }


    document.onkeydown = function () {

        if (event.keyCode == 39) {
            // ->
            // previewRight();
            event.keyCode = 0;
            event.returnValue = false;
        } else if (event.keyCode == 37) {
            // <-
            // previewLeft();
            event.keyCode = 0;
            event.returnValue = false;
        } else if (event.keyCode == 40) {
            // down
            // previewDown();
            event.keyCode = 0;
            event.returnValue = false;
        } else if (event.keyCode == 38) {
            // up
            // previewUp();
            event.keyCode = 0;
            event.returnValue = false;
        } else if (event.keyCode == 27) {
            // esc
            event.keyCode = 0;
            event.returnValue = false;
        }
    };

    document.onkeyup = function () {

        console.log("keycode=" + event.keyCode);

        if (event.keyCode == 39) {
            // ->
            previewRight();
            event.keyCode = 0;
            event.returnValue = false;
        } else if (event.keyCode == 37) {
            // <-
            previewLeft();
            event.keyCode = 0;
            event.returnValue = false;
        } else if (event.keyCode == 40) {
            // down
            previewDown();
            event.keyCode = 0;
            event.returnValue = false;
        } else if (event.keyCode == 38) {
            // up
            previewUp();
            event.keyCode = 0;
            event.returnValue = false;
        } else if (event.keyCode == 27) {
            // esc
            dismissImagePreview();
        }
    };

    queryAlbumDetail(window.localStorage.getItem("image_album_name"));
</script>
</html>