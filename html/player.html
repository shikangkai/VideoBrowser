<!DOCTYPE html>
<html lang="en" style="font-size: 10px; font-family: Roboto, Arial, sans-serif; background-color: #FAFAFA">
<head>
    <meta charset="UTF-8">
    <title>V-Play</title>
    <script src="../js/jquery-3.3.1.js"></script>
    <script src="../js/common.js"></script>
</head>
<link rel="stylesheet" type="text/css" href="../css/index.css">
<body style="overflow-y: scroll">

<script>

    var RELATIVE_PATH_PREFIX = "../../";
    var TAG_VIDEO_COUNT_PER_PAGE = 50;
    var currentTagVideoPageNumber = 0;
    var isPlayHighMode = false;
    var isPlayContinueMode = true;
    var isPlayRandomMode = false;
    var isLockPlayList = false;
    var videoStepIntervalSecs = 10;

    function switchPlayHighMode() {
        isPlayHighMode = !isPlayHighMode;
        updatePlayHighMode();
    }

    function updatePlayHighMode() {
        var div = $("#play-high");
        if (isPlayHighMode) {
            div.addClass("tag-selected");
            div.removeClass("tag-unselected");
        } else {
            div.addClass("tag-unselected");
            div.removeClass("tag-selected");
        }
    }

    function switchPlayContinueMode() {
        isPlayContinueMode = !isPlayContinueMode;
        updatePlayContinueMode();
    }

    function updatePlayContinueMode() {
        var div = $("#play-continue");
        if (isPlayContinueMode) {
            div.addClass("tag-selected");
            div.removeClass("tag-unselected");
        } else {
            div.addClass("tag-unselected");
            div.removeClass("tag-selected");
        }
    }

    function switchPlayRandomMode() {
        isPlayRandomMode = !isPlayRandomMode;
        updatePlayRandomMode();
    }

    function updatePlayRandomMode() {
        var div = $("#play-random");
        if (isPlayRandomMode) {
            div.addClass("tag-selected");
            div.removeClass("tag-unselected");
        } else {
            div.addClass("tag-unselected");
            div.removeClass("tag-selected");
        }
    }

    function switchLockPlayListMode() {
        isLockPlayList = !isLockPlayList;
        updateLockPlayListMode();
    }

    function updateLockPlayListMode() {
        var div = $("#lock-play-list");
        if (isLockPlayList) {
            div.addClass("tag-selected");
            div.removeClass("tag-unselected");
        } else {
            div.addClass("tag-unselected");
            div.removeClass("tag-selected");
        }
    }

    function switchTabPlaySettings() {

        document.getElementById("tab-play-list").src = "../img/list-unchecked.svg";
        document.getElementById("tab-play-settings").src = "../img/settings-checked.svg";

        document.getElementById("play-list").innerHTML = `
                <span id="play-high" class="tag-bg" onclick="switchPlayHighMode()">Play From HIGH</span>
                <span id="play-continue" class="tag-bg" onclick="switchPlayContinueMode()">Play Continue</span>
                <span id="play-random" class="tag-bg" onclick="switchPlayRandomMode()">Play Randomly</span>
                <span id="lock-play-list" class="tag-bg" onclick="switchLockPlayListMode()">Lock Play List</span>
        `;
        updatePlayHighMode();
        updatePlayContinueMode();
        updatePlayRandomMode();
        updateLockPlayListMode();
    }

    function switchTabPlayList() {
        document.getElementById("tab-play-list").src = "../img/list-checked.svg";
        document.getElementById("tab-play-settings").src = "../img/settings-unchecked.svg";
        showPlayList(true);
    }

    function isTabShow(index) {
        switch (index) {
            case 0:
                return !document.getElementById("tab-info").innerHTML.includes('bbb');

            case 1:
                return !document.getElementById("tab-tags").innerHTML.includes('bbb');

            case 2:
                return !document.getElementById("tab-libs").innerHTML.includes('bbb');

            case 3:
                return !document.getElementById("tab-high").innerHTML.includes('bbb');

            case 4:
                return !document.getElementById("tab-more").innerHTML.includes('bbb');

        }

        return false;

    }

    function clickTabIndex(index) {

        document.getElementById("tab-info").innerHTML = `<span style="color: #bbb; cursor: pointer" onclick="clickTabIndex(0)">INFO</span>`;
        document.getElementById("tab-tags").innerHTML = `<span style="color: #bbb; cursor: pointer" onclick="clickTabIndex(1)">TAGS</span>`;
        document.getElementById("tab-libs").innerHTML = `<span style="color: #bbb; cursor: pointer" onclick="clickTabIndex(2)">LIBS</span>`;
        document.getElementById("tab-high").innerHTML = `<span style="color: #bbb; cursor: pointer" onclick="clickTabIndex(3)">HIGH</span>`;
        document.getElementById("tab-more").innerHTML = `<span style="color: #bbb; cursor: pointer" onclick="clickTabIndex(4)">MORE</span>`;

        document.getElementById("tag-list").innerHTML = ``;
        document.getElementById("video-list").innerHTML = ``;
        document.getElementById("video-list-page-controller").innerHTML = ``;
        document.getElementById("high-range-add").innerHTML = ``;
        document.getElementById("high-range-list").innerHTML = ``;
        document.getElementById("more-options").innerHTML = ``;
        document.getElementById("video-info").innerHTML = ``;

        switch (index) {
            case 0:
                document.getElementById("tab-info").innerHTML = `<span>INFO</span>`;
                updateVideoInfo();
                break;

            case 1:
                document.getElementById("tab-tags").innerHTML = `<span>TAGS</span>`;
                updateVideoTags();
                break;

            case 2:
                document.getElementById("tab-libs").innerHTML = `<span>LIBS</span>`;
                showVideoList(null);
                break;

            case 3:
                document.getElementById("tab-high").innerHTML = `<span>HIGH</span>`;
                updateVideoHighRange();
                break;

            case 4:
                document.getElementById("tab-more").innerHTML = `<span>MORE</span>`;
                updateMoreOptions();
                break;
        }



    }

    function moveToTrash() {
        if (confirm("Move video \"" + playHistory[playHistoryIndex].title + "\" to trash ?")) {
            deleteVideo(playHistory[playHistoryIndex].id, 1);
        }
    }

    function restoreFromTrash() {
        if (confirm("Restore video \"" + playHistory[playHistoryIndex].title + "\" from trash ?")) {
            deleteVideo(playHistory[playHistoryIndex].id, 0);
        }
    }

    function downloadVideo() {

        const elt = document.createElement("a");
        elt.setAttribute("href", RELATIVE_PATH_PREFIX + playHistory[playHistoryIndex].src);
        elt.setAttribute("download", playHistory[playHistoryIndex].title + ".mp4");
        elt.style.display = "none";
        elt.rel = 'noopener noreferrer'
        document.body.appendChild(elt);
        elt.click();
        document.body.removeChild(elt);
    }

    function deleteHighRange(id, videoId) {
        $.ajax({
            url: "http://localhost:8880/action",
            method: "GET",
            data: {type: "delete-high-range", id: id},
            dataType: "json",
            success: function (data) {
                if (data.code == 0) {
                    queryVideoInformation(videoId);
                }
            }
        });
    }

    function seekVideoTo(ts) {
        document.getElementById("player").currentTime = ts / 1000;
    }

    function updateVideoHighRange() {
        if (!isTabShow(3)) {
            return;
        }

        document.getElementById("tab-options").innerHTML = `
                <div class="tag-bg tag-selected" id="option-high-range-edit" onclick="startAddHighRange()">
                    <img id="icon-high-range-edit" src="../img/add.svg" style="width: 14px">
                    <span id="text-high-range-edit" style="margin-left: 10px">Add</span>
                </div>
                `;

        var highRangesDiv = "";
        if (highRanges.length > 0) {
            var total = playHistory[playHistoryIndex].duration_ms;
            for (var i = 0; i < highRanges.length; i++) {
                var left = 900 * highRanges[i].start_ms / total;
                var width = 900 * (highRanges[i].end_ms - highRanges[i].start_ms) / total;
                highRangesDiv += `
            <div style="position: relative; left: 0; top: 0; height: 20px; margin-top: 5px; margin-bottom: 5px">
                <img style="position: absolute; left: 920px; top: 3px; width: 14px; height: 14px; cursor: pointer" onclick="deleteHighRange(${highRanges[i].id}, ${highRanges[i].video_id})" src="../img/delete.svg">
                <span style="position: absolute; left: 0; top: 5px; width: 900px; height: 10px; border-radius: 4px; background-color: #efefef; cursor: pointer" onclick="seekVideoTo(${highRanges[i].start_ms})" />
                <span style="position: absolute; left: ${left}px; top: 0px; width: ${width}px; height: 10px; border-radius: 4px; background-color: #F44336" />
            </div>
            `;
            }
        } else {
            highRangesDiv = `<div class="tag-bg tag-selected" style="margin-right: 3px" >No High Ranges</div>`;
        }

        document.getElementById("high-range-list").innerHTML = highRangesDiv;
    }

    function resetHighRange() {
        markHighRangeStartMs = -1;
        markHighRangeEndMs = -1;
        try {
            document.getElementById("icon-high-range-edit").src = "../img/add.svg";
            document.getElementById("text-high-range-edit").innerHTML = "Add";
            document.getElementById("option-high-range-edit").onclick = startAddHighRange;
            document.getElementById("high-range-add").innerHTML = ``;
        } catch (e) {
            console.log(e);
        }
    }

    function markHighRangeStart() {
        var progress = parseInt(document.getElementById("player").currentTime * 1000);
        if (markHighRangeEndMs >= 0 && progress > markHighRangeEndMs) {
            markHighRangeStartMs = markHighRangeEndMs;
            markHighRangeEndMs = progress;
        } else {
            markHighRangeStartMs = progress;
        }

        updateAddHighRange();
    }

    function markHighRangeEnd() {
        var progress = parseInt(document.getElementById("player").currentTime * 1000);
        if (markHighRangeStartMs >= 0 && progress < markHighRangeStartMs) {
            markHighRangeEndMs = markHighRangeStartMs;
            markHighRangeStartMs = progress;
        } else {
            markHighRangeEndMs = progress;
        }
        updateAddHighRange();
    }

    function cancelMarkHighRange() {

        markHighRangeStartMs = -1;
        markHighRangeEndMs = -1;
        resetHighRange();
    }

    function updateAddHighRange() {

        var duration = playHistory[playHistoryIndex].duration_ms;
        var left = 0;
        var width = 0;

        if (markHighRangeStartMs < 0) {
            left = 0;
            if (markHighRangeEndMs < 0) {
                width = 0;
            } else {
                width = parseInt(900.0 * markHighRangeEndMs / duration);
            }
        } else {
            left = parseInt(900.0 * markHighRangeStartMs / duration);
            if (markHighRangeEndMs < 0) {
                width = 900 - left;
            } else {
                width = parseInt(900.0 * (markHighRangeEndMs - markHighRangeStartMs) / duration);
            }
        }

        var div = `
            <div style="position: relative; left: 0; top: 0; height: 40px; margin-bottom: 10px">
                <span class="tag-bg" style="position: absolute; left: 912px; top: 0; width: 56px; height: 20px" onclick="markHighRangeStart()">标记开始</span>
                <span class="tag-bg" style="position: absolute; left: 998px; top: 0; width: 56px; height: 20px" onclick="markHighRangeEnd()">标记结束</span>
                <span class="tag-bg" style="position: absolute; left: 1084px; top: 0; width: 56px; height: 20px" onclick="cancelMarkHighRange()">取消标记</span>
                <span style="position: absolute; left: 0; top: 0px; width: 900px; height: 40px; border-radius: 4px; background-color: #efefef" />
                <span style="position: absolute; left: ${left}px; top: 0px; width: ${width}px; height: 40px; border-radius: 4px; background-color: #F44336" />
            </div>
        `;
        document.getElementById("high-range-add").innerHTML = div;
    }
    
    function startAddHighRange() {

        document.getElementById("icon-high-range-edit").src = "../img/done.svg";
        document.getElementById("text-high-range-edit").innerHTML = "Finish";
        document.getElementById("option-high-range-edit").onclick = finishAddHighRange;
        updateAddHighRange();

    }

    function finishAddHighRange() {

        if (markHighRangeStartMs < 0 && markHighRangeEndMs < 0) {
            alert("标记错误");
            return;
        }

        if (markHighRangeStartMs < 0) {
            markHighRangeStartMs = 0;
        }

        if (markHighRangeEndMs < 0) {
            markHighRangeEndMs = playHistory[playHistoryIndex].duration_ms;
        }

        $.ajax({
            url: "http://localhost:8880/action",
            method: "GET",
            data: {type: "add-high-range", video_id: playHistory[playHistoryIndex].id, start_ms: markHighRangeStartMs, end_ms: markHighRangeEndMs},
            dataType: "json",
            success: function (data) {
                if (data.code == 0) {
                    queryVideoInformation(playHistory[playHistoryIndex].id);
                }
            }
        });

        resetHighRange();
    }

    function updateMoreOptions() {
        if (!isTabShow(4)) {
            return;
        }

        document.getElementById("tab-options").innerHTML = `<div class="tag-bg tag-selected">No Settings</div>`;
    }

    function switchLibTagMode() {
        var iconLibMode = document.getElementById("icon-lib-mode");
        if (iconLibMode.src.endsWith("/expand.svg")) {
            iconLibMode.src = "../img/unexpand.svg";
            document.getElementById("text-lib-mode").innerHTML = "Fold Tags"
            fetchAllTags(false)
        } else {
            iconLibMode.src = "../img/expand.svg";
            document.getElementById("text-lib-mode").innerHTML = "Expand Tags"
            document.getElementById("tag-list").innerHTML = "";
        }
    }

    function deletePlayListIndex(index) {
        if (index == playHistory.length - 1) {
            // 删除最后一个
            if (index == playHistoryIndex) {
                // 删除正在播放
                playHistory.splice(index, 1);
                playHistoryIndex--;
                if (playHistoryIndex >= 0) {
                    playVideoByHistoryIndex(playHistoryIndex);
                } else {
                    playNextVideo();
                }
            } else {
                // 删除非正在播放
                playHistory.splice(index, 1);

                if (index < playHistoryIndex) {
                    playHistoryIndex--;
                }
            }
        } else {
            // 删除非最后一个
            if (index == playHistoryIndex) {
                // 删除正在播放
                playHistory.splice(index, 1);
                playHistoryIndex--;
                playNextVideo();
            } else {
                // 删除非正在播放
                playHistory.splice(index, 1);

                if (index < playHistoryIndex) {
                    playHistoryIndex--;
                }
            }
        }
        showPlayList(true);
    }

    function showPlayList(notScroll) {

        // check
        if (!document.getElementById("tab-play-list").src.endsWith("list-checked.svg")) {
            return;
        }

        var originalTop = document.getElementById("play-list").scrollTop;

        if (playHistory.length > 0) {
            var videosDiv = "";
            for (var i = 0; i < playHistory.length; i++) {
                videosDiv = videosDiv + genVideoListItem(playHistory[i], i);
            }
            document.getElementById("play-list").innerHTML = videosDiv;
            document.getElementById("video-list-index-" + playHistoryIndex).innerHTML = `<img class="current-play" src="../img/playing.png" style="height: 30px; width: 30px; padding-top: 41px; padding-bottom: 41px; padding-left: 95px; padding-right: 95px; background-color: rgba(0, 0, 0, 0.7);">`;
        } else {
            // document.getElementById("play-list").innerHTML = `<div style="font-size: 1.4em; text-align: -webkit-center;"><span class="icon-empty" /><br />播放列表为空</div>`;
        }

        if (notScroll) {
            document.getElementById("play-list").scrollTop = originalTop;
            return
        }

        var videoHeight = 112;
        var videoMargin = 10;

        var currentVideoY = playHistoryIndex * (videoHeight + videoMargin);

        var minY = document.getElementById("play-list").scrollTop;
        var maxY = document.getElementById("play-list").scrollTop + document.getElementById("play-list").clientHeight;

        if (currentVideoY < minY) {
            document.getElementById("play-list").scrollTop = currentVideoY;
        } else if (currentVideoY > maxY) {
            document.getElementById("play-list").scrollTop = currentVideoY + videoHeight - document.getElementById("play-list").clientHeight;
        }
    }

    function showVideoList(tagName) {
        if (!isTabShow(2)) {
            return;
        }

        if (tagName == null) {
            document.getElementById("tab-options").innerHTML = `
                <div class="tag-bg tag-selected" id="option-lib-mode" onclick="switchLibTagMode()">
                    <img id="icon-lib-mode" src="../img/expand.svg" style="width: 14px">
                    <span id="text-lib-mode" style="margin-left: 10px">Expand Tags</span>
                </div>
                `;
        } else {
            document.getElementById("tab-options").innerHTML = `
                <div class="tag-bg tag-selected" id="option-lib-mode" onclick="switchLibTagMode()">
                    <img id="icon-lib-mode" src="../img/expand.svg" style="width: 14px">
                    <span id="text-lib-mode" style="margin-left: 10px">Expand Tags</span>
                </div>

                <font style="font-size: 1.4em; line-height: 1.6em; color: #444">Current video list from tag <font style="color: #F44336"><b>${tagName}</b></font></font>
                `;
        }

        loadPageVideo(0);
    }

    function loadPageVideo(pageNumber) {

        currentTagVideoPageNumber = pageNumber;
        var videosDiv = "";

        if (videoList.length > 0) {
            for (var i = currentTagVideoPageNumber * TAG_VIDEO_COUNT_PER_PAGE; i < videoList.length && i < currentTagVideoPageNumber * TAG_VIDEO_COUNT_PER_PAGE + TAG_VIDEO_COUNT_PER_PAGE; i++) {
                videosDiv = videosDiv + genVideoLibItem(videoList[i]);
            }
        } else {
            videosDiv = `<div style="font-size: 1.4em; text-align: -webkit-center;"><span class="icon-empty" /><br />不存在 Tag 为 <b>${tagName}</b> 视频资源</div>`;
        }
        document.getElementById("video-list").innerHTML = videosDiv;
        document.getElementById("video-list-page-controller").innerHTML = getPageControllerDiv(videoList.length, TAG_VIDEO_COUNT_PER_PAGE, loadPageVideo, currentTagVideoPageNumber, "tag-video-list");
        document.getElementById("tag-list").innerHTML = ``;
    }

    function queryTagVideoList(tagId, tagName) {
        $.ajax({
            url: "http://localhost:8880/information",
            method: "GET",
            data: {type: "video-list", tag_ids: tagId, query_type: "and"},
            dataType: "json",
            success: function (data) {
                if (data.code == 0 && data.data != null) {
                    videoList = data.data;
                    showVideoList(tagName);
                }
            }
        });
    }

    function markCurrentPlayVideoProgress() {
        if (playHistoryIndex == -1 || playHistoryIndex >= playHistory.length) {
            return;
        }

        playHistory[playHistoryIndex].progress_ms = document.getElementById("player").currentTime * 1000;
    }

    function playVideoByHistoryIndex(index) {
        markCurrentPlayVideoProgress();
        playHistoryIndex = index;
        playVideo(playHistory[index]);
    }

    function playVideoById(videoId) {
        for (var i = 0; i < videoList.length; i++) {
            if (videoList[i].id == videoId) {
                playIndexVideo(i);
                return;
            }
        }
    }

    function updateVideoTags() {
        if (!isTabShow(1)) {
            return;
        }

        document.getElementById("tab-options").innerHTML = `
                <div class="tag-bg tag-selected" id="option-tag-edit" onclick="startEditTags()">
                    <img id="icon-tag-edit" src="../img/edit.svg" style="width: 14px">
                    <span id="text-tag-edit" style="margin-left: 10px">Edit</span>
                </div>
                `;

        if (tagNames == null || tagNames.length == 0) {
            document.getElementById("tag-list").innerHTML = `<div class="tag-bg tag-selected" style="margin-right: 3px" >No Tags</div>`;
            return;
        }

        var tagsDiv = "";
        for (var i = 0; i < tagNames.length; i++) {
            tagsDiv = tagsDiv + `<div class="tag-bg tag-unselected" style="margin-right: 3px" id="tag-${tagIds[i]}" onclick="queryTagVideoList(${tagIds[i]}, '${tagNames[i]}')">${tagNames[i]}</div>&nbsp;&nbsp;`;
        }
        document.getElementById("tag-list").innerHTML = tagsDiv;
    }

    function queryVideoInformation(videoId) {

        $.ajax({
            url: "http://localhost:8880/information",
            method: "GET",
            data: {type: "video", video_id: videoId},
            dataType: "json",
            success: function (data) {
                if (data.code == 0) {
                    console.log(data);
                    tagNames = data.data.tag_names;
                    tagIds = data.data.tag_ids == null ? [] : data.data.tag_ids;
                    highRanges = data.data.high_ranges == null ? [] : data.data.high_ranges;

                    for (var i = 0; i < highRanges.length; i++) {
                        for (var j = i + 1; j < highRanges.length; j++) {
                            if (highRanges[i].start_ms > highRanges[j].start_ms) {
                                var tmp = highRanges[i];
                                highRanges[i] = highRanges[j];
                                highRanges[j] = tmp;
                            }
                        }
                    }

                    for (var i = 0; i < playHistory.length; i++) {
                        if (playHistory[i].id == videoId) {
                            if (playHistoryIndex == i && playHistory[i].high_ranges == null) {
                                if (highRanges.length > 0 && isPlayHighMode) {
                                    seekVideoTo(highRanges[0].start_ms);
                                }
                            }
                            playHistory[i].high_ranges = highRanges;
                        }
                    }
                    for (var i = 0; i < videoList.length; i++) {
                        if (videoList[i].id == videoId) {
                            videoList[i].high_ranges = highRanges;
                        }
                    }
                    updateVideoTags();
                    updateVideoHighRange();
                }
            }
        });
    }

    function playVideo(video) {

        videoId = video.id;

        $.ajax({
            crossDomain: true,
            url: "http://localhost:8880/action",
            data: {type: "play-video", video_id: video.id},
            method: "GET"
        });

        queryVideoInformation(video.id);

        document.getElementById("player").src = RELATIVE_PATH_PREFIX + video.src;
        document.getElementById("player").volume = 1.0;
        $(".v-cover-title").removeClass("tag-selected");
        $("#title-" + video.id).addClass("tag-selected");
        document.getElementById("video-name").innerHTML = `&nbsp;&nbsp;${video.title}`;

        if (isPlayHighMode && video.high_ranges != null && video.high_ranges.length > 0) {
            seekVideoTo(video.high_ranges[0].start_ms);
        } else if (isPlayContinueMode && video.progress_ms != null && video.progress_ms <= video.duration_ms - 5000) {
            seekVideoTo(video.progress_ms);
        }

        // var information = "";
        // information = information + `<div class="tag-bg tag-unselected" >Resolution ${video.width}x${video.height} px</div>&nbsp;&nbsp;`;
        // information = information + `<div class="tag-bg tag-unselected" >Update ${getTimeDistanceString(video.modify_time)}</div>&nbsp;&nbsp;`;
        // information = information + `<div class="tag-bg tag-unselected" >Viewed ${video.view_count} time(s)</div>&nbsp;&nbsp;`;
        // document.getElementById("video-information").innerHTML = information;
        updateVideoInfo();
        resetEditTags();
        resetHighRange();
        showPlayList(false);

        videoStepIntervalSecs = video.duration_ms / 1000 / 50;
        if (videoStepIntervalSecs < 5) {
            videoStepIntervalSecs = 5;
        }

        if (videoStepIntervalSecs > 60) {
            videoStepIntervalSecs = 60;
        }

    }

    function moveUpInPlayList(index) {
        moveUpInPlayList(index, true);
    }

    function moveUpInPlayList(index, notScroll) {
        if (index == 0) {
            return;
        }

        var playHistTmp = playHistory[index];
        playHistory[index] = playHistory[index - 1];
        playHistory[index - 1] = playHistTmp;

        if (index == playHistoryIndex) {
            playHistoryIndex = index - 1;
        } else if (index - 1 == playHistoryIndex) {
            playHistoryIndex = index;
        }
        showPlayList(notScroll);
    }

    function moveDownInPlayList(index) {
        moveDownInPlayList(index, true);
    }

    function moveDownInPlayList(index, notScroll) {
        if (index == playHistory.length - 1) {
            return;
        }
        var playHistTmp = playHistory[index];
        playHistory[index] = playHistory[index + 1];
        playHistory[index + 1] = playHistTmp;

        if (index == playHistoryIndex) {
            playHistoryIndex = index + 1;
        } else if (index + 1 == playHistoryIndex) {
            playHistoryIndex = index;
        }
        showPlayList(notScroll);
    }

    function showPlayListOrderController(index) {
        var content = `<img src="../img/play-up.svg" style="width: 24px; height: 24px; position: absolute; left: 0; top: 0; padding: 16px; background-color: rgba(0, 0, 0, 0.7);" onclick="moveUpInPlayList(${index})" /><img src="../img/play-down.svg" style="width: 24px; height: 24px; position: absolute; left: 0; top: 56px; padding: 16px; background-color: rgba(0, 0, 0, 0.7);" onclick="moveDownInPlayList(${index})" />`;
        document.getElementById("play-list-order-controller-index-" + index).innerHTML = content;
    }

    function hideListOrderController(index) {
        document.getElementById("play-list-order-controller-index-" + index).innerHTML = "";
    }

    function genVideoListItem(object, index) {
        var isHd = ``;
        var durationStr = genDurationStr(object.duration_ms);
        if (object.width >= 480 && object.height >= 480) {
            isHd = `<b><i>HD</i></b>&ensp;`;
        }

        var video =
            `<div class="v-item" style="padding: 0px; margin-bottom: ${index == (playHistory.length - 1) ? 0 : 10 }px; width: 220px; height: 112px;" onmouseenter="javascript: loadImage('${object.md5}', '${RELATIVE_PATH_PREFIX + object.gif}'); showPlayListOrderController(${index});" onmouseleave="javascript: loadImage('${object.md5}', '${RELATIVE_PATH_PREFIX + object.jpg}'); hideListOrderController(${index});" >
                <div class="v-container" style="width: 220px; height: 112px;">
                    <img src="${RELATIVE_PATH_PREFIX + object.jpg}" class="v-thumbnail" id="${object.md5}" style="width: 220px; height: 112px; object-fit: ${getThumbnailFitType(object.width, object.height)}; background: ${getThumbnailBackground(object.width, object.height)};" onclick="playVideoByHistoryIndex(${index})" />
                    <span style="position: absolute; left: 0; top: 0;" id="video-list-index-${index}"></span>
                    <span class="v-duration"><b>${isHd}${durationStr}</b></span>
                    <span style="position: absolute; right: 0; top: 0; background-color: rgba(0, 0, 0, 0.7);"><img src="../img/play-delete.svg" style="height: 30px; width: 30px;" onclick="deletePlayListIndex(${index})"></span>
                    <span style="position:absolute; left: 0; top: 0;" id="play-list-order-controller-index-${index}"></span>
                </div>
            </div>`
        return video;
    }

    function genVideoLibItem(object) {
        var isHd = ``;
        var durationStr = genDurationStr(object.duration_ms);
        if (object.width >= 480 && object.height >= 480) {
            isHd = `<b><i>HD</i></b>&ensp;`;
        }

        var video =
            `<div class="v-item" style="padding: 0px; margin-bottom: 10px; width: 220px; height: 112px; margin-right: 16px">
                <div class="v-container" style="width: 220px; height: 112px;">
                    <img src="${RELATIVE_PATH_PREFIX + object.jpg}" class="v-thumbnail" id="${object.md5}" style="width: 220px; height: 112px; object-fit: ${getThumbnailFitType(object.width, object.height)}; background: ${getThumbnailBackground(object.width, object.height)};" onclick="playVideoById(${object.id})" onmouseenter="loadImage('${object.md5}', '${RELATIVE_PATH_PREFIX + object.gif}')" onmouseleave="loadImage('${object.md5}', '${RELATIVE_PATH_PREFIX + object.jpg}')" />
                    <span class="v-duration"><b>${isHd}${durationStr}</b></span>
                </div>
            </div>`
        return video;
    }

    function playNextVideo() {
        markCurrentPlayVideoProgress();
        // 播放下一个

        var toPlayVideo;
        if (playHistoryIndex == playHistory.length - 1) {
            toPlayVideo = playHistory[0];
            if (!isLockPlayList) {
                // 重新生成
                if (isPlayRandomMode) {
                    toPlayVideo = videoList[(parseInt(Math.random() * videoList.length) + playHistoryIndex) % videoList.length];
                } else {
                    var player = document.getElementById("player");
                    var src = player.src;
                    var playIndex = 0;
                    for (var i = 0; i < videoList.length; i++) {
                        if (src.indexOf(videoList[i].md5) >= 0) {
                            playIndex = i;
                            break;
                        }
                    }

                    if (playIndex == videoList.length - 1) {
                        toPlayVideo = videoList[0];
                    } else {
                        toPlayVideo = videoList[i + 1];
                    }
                }


                // 判断当前视频是否已经存在，若存在则直接播放列表中的视频、
                var videoExistsInHistory = false;
                for (var i = 0; i < playHistory.length; i++) {
                    if (toPlayVideo.id == playHistory[i].id) {
                        toPlayVideo = playHistory[i];
                        playHistoryIndex = i;
                        videoExistsInHistory = true;
                    }
                }

                if (!videoExistsInHistory) {
                    playHistory[++playHistoryIndex] = toPlayVideo;
                }
            } else {
                playHistoryIndex = 0;
            }
        } else {
            toPlayVideo = playHistory[++playHistoryIndex];
        }

        playVideo(toPlayVideo)
    }

    function playPriorVideo() {
        markCurrentPlayVideoProgress();
        // 播放上一个

        if (playHistoryIndex == 0) {
            playVideo(playHistory[playHistoryIndex = playHistory.length - 1]);
        } else {
            playVideo(playHistory[--playHistoryIndex]);
        }
    }

    function playIndexVideo(index) {
        markCurrentPlayVideoProgress();
        playHistoryIndex++;
        playHistory.splice(playHistoryIndex, 0, videoList[index]);
        playVideo(playHistory[playHistoryIndex]);
    }

    function playForward() {
        var player = document.getElementById("player");
        player.currentTime += videoStepIntervalSecs;
    }

    function playBackward() {
        var player = document.getElementById("player");
        player.currentTime -= videoStepIntervalSecs;
    }

    function clearPlayList() {
        playHistoryIndex = -1;
        playHistory = [];
        showPlayList(false);
    }

    function switchTag(tagId) {
        var tag = $("#tag-" + tagId);
        if (tag.hasClass("tag-selected")) {
            tag.removeClass("tag-selected");
            tag.addClass("tag-unselected");
        } else {
            tag.removeClass("tag-unselected");
            tag.addClass("tag-selected");
        }
    }
    
    function getSelectedTagIds() {
        var selectedTagIds = [];
        $("div[id^='tag-'][class*='tag-selected']").each(function (index, element) {
            selectedTagIds[selectedTagIds.length] = element.id.split("-")[1];
        })
        return selectedTagIds;
    }

    function fetchAllTags(mark) {

        $.ajax({
            crossDomain: true,
            url: "http://localhost:8880/information",
            data: {type: "tag-list"},
            method: "GET",
            dataType: "json",
            success: function (data) {
                if (data.code == 0 && data.data != null) {
                    tagList = data.data;

                    var tagsDiv = "";
                    for (var i = 0; i < tagList.length; i++) {
                        var selectClass = "tag-unselected";
                        if (mark) {
                            for (var j = 0; j < tagIds.length; j++) {
                                if (tagList[i].id == tagIds[j]) {
                                    selectClass = "tag-selected";
                                    break;
                                }
                            }
                            tagsDiv = tagsDiv + `<div class="tag-bg ` + selectClass + `" style="margin-right: 3px" id="tag-${tagList[i].id}" onclick="switchTag(${tagList[i].id})">${tagList[i].name} (${tagList[i].count})</div>&nbsp;&nbsp;`;
                        } else {
                            tagsDiv = tagsDiv + `<div class="tag-bg ` + selectClass + `" style="margin-right: 3px" id="tag-${tagList[i].id}" onclick="queryTagVideoList(${tagList[i].id}, '${tagList[i].name}')">${tagList[i].name} (${tagList[i].count})</div>&nbsp;&nbsp;`;
                        }
                    }
                    document.getElementById("tag-list").innerHTML = tagsDiv;
                }
            }
        });
    }

    function deleteVideo(videoId, deleted) {
        $.ajax({
            crossDomain: true,
            url: "http://localhost:8880/action",
            data: {type: "delete-video", video_id: videoId, deleted: deleted},
            method: "GET",
            dataType: "json",
            success: function (data) {
                if (data.code == 0) {
                    for (var i = 0; i < videoList.length; i++) {
                        if (videoList[i].id == videoId) {
                            videoList[i].deleted = deleted;
                            break;
                        }
                    }
                    updateVideoInfo();
                }
            }
        });
    }

    function startEditTags() {

        document.getElementById("icon-tag-edit").src = "../img/done.svg";
        document.getElementById("text-tag-edit").innerHTML = "Finish"
        document.getElementById("option-tag-edit").onclick = finishEditTags;
        document.getElementById("tag-list").innerHTML = `<div class="tag-bg tag-unselected" >Fetching all tags...</div>&nbsp;&nbsp;`;

        fetchAllTags(true);
    }

    function finishEditTags() {
        document.getElementById("icon-tag-edit").src = "../img/edit.svg";
        document.getElementById("text-tag-edit").innerHTML = "Edit"
        document.getElementById("option-tag-edit").onclick = startEditTags;

        var selectTagIds = getSelectedTagIds();
        $.ajax({
            crossDomain: true,
            url: "http://localhost:8880/action",
            data: {type: "modify-video-tag", video_id: videoId, tag_ids: selectTagIds.join(",")},
            method: "GET",
            dataType: "json",
            success: function (data) {
                if (data.code == 0 && data.data != null && data.data.length != 0) {
                    if (data.data == null || data.data.length == 0) return;

                    var tagsDiv = "";
                    for (var i = 0; i < data.data.length; i++) {
                        var selectClass = "tag-unselected";
                        for (var j = 0; j < tagIds.length; j++) {
                            if (data.data[i].id == tagIds[j]) {
                                selectClass = "tag-selected";
                                break;
                            }
                        }
                        tagsDiv = tagsDiv + `<div class="tag-bg ` + selectClass + `" id="tag-${data.data[i].id}" onclick="switchTag(${data.data[i].id})">${data.data[i].name} (${data.data[i].count})</div>&nbsp;&nbsp;`;
                    }
                    document.getElementById("tag-list").innerHTML = tagsDiv;
                }
            }
        });
        // 更新视图显示
        tagNames = [];
        tagIds = [];
        for (var i = 0; i < selectTagIds.length; i++) {
            var tagId = parseInt(selectTagIds[i]);
            for (var j = 0; j < tagList.length; j++) {
                if (tagId == tagList[j].id) {
                    tagNames[tagNames.length] = tagList[j].name;
                    tagIds[tagIds.length] = tagList[j].id;
                    break;
                }
            }
        }
        updateVideoTags();

    }

    function updateVideoInfo() {
        if (!isTabShow(0)) {
            return;
        }

        if (playHistoryIndex == -1) {
            return;
        }

        var videoInfo = playHistory[playHistoryIndex];

        if (videoInfo.deleted == 1) {

            document.getElementById("tab-options").innerHTML = `
                <div class="tag-bg tag-selected" onclick="restoreFromTrash()">
                    <img src="../img/delete.svg" style="width: 14px">
                    &nbsp;&nbsp;Restore
                </div>
                <div class="tag-bg tag-selected" onclick="downloadVideo()">
                    <img src="../img/download.svg" style="width: 14px">
                    &nbsp;&nbsp;Download
                </div>
                `;
        } else {
            document.getElementById("tab-options").innerHTML = `
                <div class="tag-bg tag-selected" onclick="moveToTrash()">
                    <img src="../img/delete.svg" style="width: 14px">
                    &nbsp;&nbsp;Delete
                </div>
                <div class="tag-bg tag-selected" onclick="downloadVideo()">
                    <img src="../img/download.svg" style="width: 14px">
                    &nbsp;&nbsp;Download
                </div>
                `;
        }

        document.getElementById("video-info").innerHTML = `
            <table style="border-width: 0; font-size: 1.4em; line-height: 1.6em; color: #444">
                <tr>
                    <td style="width: 174px"><b>Video Title</b></td>
                    <td>${videoInfo.title}</td>
                </tr>
                <tr>
                    <td style="width: 174px"><b>Video Resolution</b></td>
                    <td>${videoInfo.width}×${videoInfo.height}</td>
                </tr>
                <tr>
                    <td><b>Video Duration</b></td>
                    <td>${genDurationStr(videoInfo.duration_ms)}</td>
                </tr>
                <tr>
                    <td><b>File Size</b></td>
                    <td>${getFileSizeStr(videoInfo.size_byte)}</td>
                </tr>
                <tr>
                    <td><b>Modify Time</b></td>
                    <td>${new Date(videoInfo.modify_time)}</td>
                </tr>
                <tr>
                    <td><b>Meta Information</b></td>
                    <td>${videoInfo.md5} (${videoInfo.id})</td>
                </tr>
            </table>
        `;
    }

    function resetEditTags() {
        try {
            document.getElementById("icon-tag-edit").src = "../img/edit.svg";
            document.getElementById("option-tag-edit").onclick = startEditTags;
        } catch (e) {
            console.log(e);
        }
    }

    function playVideoResumeOrPause() {
        var player = document.getElementById("player");
        if (player.paused) {
            player.play();
        } else {
            player.pause();
        }
    }

    function playVideoFullScreenEnterOrExit() {
        var player = document.getElementById("player");
        if (document.webkitIsFullScreen) {
            player.webkitExitFullscreen();
        } else {
            player.webkitRequestFullscreen();
        }
    }

</script>

<table align="center" width="1200px" border="0px">
    <tr>
        <td valign="top">
            <div id="video-name" class='tag-title' style="display: inline-block; width: 888px; max-lines: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; height: 1.2em"></div>
            <br />

            <div id="player-container" style="background-color: #111111; display: inline-block; margin-bottom: 12px;">
                <video id='player' ref='video' autoplay style='width: 900px; height: 594px' controls>not support</video>
            </div>
        </td>
        <td width="250px" valign="top">
            <div class='tag-title' style="height: 1.2em" >
                <img id="tab-play-list" src="../img/list-checked.svg" onclick="switchTabPlayList()" style="width:16px; cursor: pointer; position: relative; left: 20px">
                <img id="tab-play-settings" src="../img/settings-unchecked.svg" onclick="switchTabPlaySettings()" style="width:16px; cursor: pointer; position: relative; left: 30px">
            </div>
            <div id="play-list" className="play-list-container" style="height: 600px; overflow: scroll; overflow-y: auto; overflow-x: hidden"></div>
        </td>
    </tr>
    <tr>
        <td colspan="2">
            <!--<div class='tag-title'>&nbsp;&nbsp;INFORMATION&nbsp;&nbsp;<img id="delete" src="../img/delete.svg" style="width: 14px; cursor: pointer" onclick="deleteVideo()"></div>-->
            <!--<div id="video-information"></div>-->

            <div class='tag-title'><span style="margin-right: 16px; margin-left: 20px" id="tab-info"></span><span style="margin-right: 16px" id="tab-tags"></span><span style="margin-right: 16px" id="tab-libs"></span><span style="margin-right: 16px" id="tab-high"></span><span id="tab-more"></span></div>
            <div id="tab-options"></div>
            <div id="video-info"></div>
            <div id="tag-list"></div>
            <div id="video-list"></div>
            <div id="video-list-page-controller" align="center"></div>
            <div id="high-range-add"></div>
            <div id="high-range-list"></div>
            <div id="more-options"></div>
        </td>
    </tr>
</table>

<script>

    var videoList = JSON.parse(window.localStorage.getItem("play_video_list"));
    var tagList = null;
    var tagNames = [];
    var tagIds = [];
    var highRanges = [];
    var videoId = 0;
    var playHistory = [];
    var playHistoryIndex = -1;

    var markHighRangeStartMs = -1;
    var markHighRangeEndMs = -1;

    showVideoList(null);
    clickTabIndex(0);
    {
        var videoId = parseInt(window.localStorage.getItem("play_video_id"));
        for (var i = 0; i < videoList.length; i++) {
            if (videoList[i].id == videoId) {
                playIndexVideo(i);
                break;
            }
        }

        var player = document.getElementById("player");
        player.addEventListener('ended', function() {
            playNextVideo();
        });
    }

    var keyCtrlIsHold = false;
    document.onkeydown = function() {

        if (event.keyCode == 32) {
            if (document.activeElement.id != "player") {
                playVideoResumeOrPause();
                event.keyCode = 0;
                event.returnValue = false;
            } else {
                // ignore
            }
        } else if (event.keyCode == 13) {
            playVideoFullScreenEnterOrExit();
            event.keyCode = 0;
            event.returnValue = false;
        } else if (event.keyCode == 38) {
            // do nothing
            event.keyCode = 0;
            event.returnValue = false;
        } else if (event.keyCode == 40) {
            // do nothing
            event.keyCode = 0;
            event.returnValue = false;
        } else if (event.keyCode == 39) {
            // ->
            playForward();
            event.keyCode = 0;
            event.returnValue = false;
        } else if (event.keyCode == 37) {
            // <-
            playBackward();
            event.keyCode = 0;
            event.returnValue = false;
        } else if (event.keyCode == 17) {
            keyCtrlIsHold = true;
            event.keyCode = 0;
            event.returnValue = false;
        }
    };

    document.onkeyup = function () {

        if (event.keyCode == 39) {
            // ->
            // playForward();
            event.keyCode = 0;
            event.returnValue = false;
        } else if (event.keyCode == 37) {
            // <-
            // playBackward();
            event.keyCode = 0;
            event.returnValue = false;
        } else if (event.keyCode == 40) {
            // play next
            if (keyCtrlIsHold) {
                moveDownInPlayList(playHistoryIndex, false);
            } else {
                playNextVideo();
            }
            event.keyCode = 0;
            event.returnValue = false;
        } else if (event.keyCode == 38) {
            // play prior
            if (keyCtrlIsHold) {
                moveUpInPlayList(playHistoryIndex, false);
            } else {
                playPriorVideo();
            }
            event.keyCode = 0;
            event.returnValue = false;
        } else if (event.keyCode == 8) {
            // delete
            deletePlayListIndex(playHistoryIndex);
            event.keyCode = 0;
            event.returnValue = false;
        } else if (event.keyCode == 17) {
            keyCtrlIsHold = false;
            event.keyCode = 0;
            event.returnValue = false;
        }
    };

    switchTabPlayList();
</script>
</body>
</html>