<!DOCTYPE html>
<html lang="en" style="font-size: 10px; font-family: Roboto, Arial, sans-serif; background-color: #FAFAFA">
<head>
    <meta charset="UTF-8">
    <title>V-Image</title>
    <script src="../js/jquery-3.3.1.js"></script>
    <script src="../js/common.js"></script>
</head>
<link rel="stylesheet" type="text/css" href="../css/index.css">

<script>

    var RELATIVE_PATH_PREFIX = "../../";

    var IMAGE_CELL_TYPE = [
        (1 << 8) + 1,
        (1 << 8) + 2,
        (2 << 8) + 1,
        (2 << 8) + 2,
    ];

    function isMapFullFill(map) {
        for (var i = 0; i < map.length; i++) {
            for (var j = 0; j < map[i].length; j++) {
                if (map[i][j] == false) {
                    return false;
                }
            }
        }

        return true;
    }

    function fillMap(map, type, x, y) {

        var row = type >> 8;
        var col = type & 255;

        for (var i = 0; i < row; i++) {
            for (var j = 0; j < col; j++) {
                if (i + x >= map.length) {
                    return false;
                }

                if (j + y >= map[i].length) {
                    return false;
                }

                if (map[i + x][j + y] == true) {
                    return false;
                }
            }
        }

        for (var i = 0; i < row; i++) {
            for (var j = 0; j < col; j++) {
                map[i + x][j + y] = true;
            }
        }

        return true;
    }

    function genImageMapDiv(images, total, name) {
        console.log("genImageMapDiv->" + name);

        var imageCellMap = [
            [false, false, false, false, false, false, false, false, false, false, false, false],
            [false, false, false, false, false, false, false, false, false, false, true, true]
        ];

        var imageIndex = 0;
        var div = ``;
        while (!isMapFullFill(imageCellMap)) {

            var random = Math.floor((Math.random() * 100));
            var type;
            if (random < 40) {
               type = IMAGE_CELL_TYPE[3];
            } else if (random < 65) {
                type = IMAGE_CELL_TYPE[2];
            } else if (random < 90) {
                type = IMAGE_CELL_TYPE[1];
            } else {
                type = IMAGE_CELL_TYPE[0];
            }


            a:
            for (var i = 0; i < imageCellMap.length; i++) {
                for (var j = 0; j < imageCellMap[i].length; j++) {

                    if (fillMap(imageCellMap, type, i, j)) {
                        div = div + getImageCellDiv(i, j, type, images[imageIndex])
                        imageIndex++;
                        break a;
                    }
                }
            }
        }

        div = div + `
            <span style="width: 200px; height: 95px; object-fit: cover; position: absolute; left: 1050px; top: 105px; border-radius: 5px; cursor: pointer; background-color: #333333; color: white; font-size: 5em; text-align: center; line-height: 95px" onclick="gotoAlbum('${name}')">${total - imageIndex}+</span>
        `;
        return div;
    }

    function getImageCellDiv(x, y, type, image) {

        switch (type) {
            case IMAGE_CELL_TYPE[0]:
                return `<img style="width: 95px; height: 95px; object-fit: cover; position: absolute; left: ${y * 105}px; top: ${x * 105}px; border-radius: 5px" src="${RELATIVE_PATH_PREFIX + image}" loading="lazy">`

            case IMAGE_CELL_TYPE[1]:
                return `<img style="width: 200px; height: 95px; object-fit: cover; position: absolute; left: ${y * 105}px; top: ${x * 105}px; border-radius: 5px" src="${RELATIVE_PATH_PREFIX + image}" loading="lazy">`

            case IMAGE_CELL_TYPE[2]:
                return `<img style="width: 95px; height: 200px; object-fit: cover; position: absolute; left: ${y * 105}px; top: ${x * 105}px; border-radius: 5px" src="${RELATIVE_PATH_PREFIX + image}" loading="lazy">`

            case IMAGE_CELL_TYPE[3]:
                return `<img style="width: 200px; height: 200px; object-fit: cover; position: absolute; left: ${y * 105}px; top: ${x * 105}px; border-radius: 5px" src="${RELATIVE_PATH_PREFIX + image}" loading="lazy">`

        }
    }

    function getAlbumDiv(index, images, total, name) {
        return `<div style="display: block; position: relative; top: 20px; height: 240px">${genImageMapDiv(images, total, name)}</div>`;
    }

    function gotoAlbum(name) {
        window.localStorage.setItem("image_album_name", name);
        window.open("img-album.html");
    }
</script>
<body>


<table align="center" width="1200px" border="0px">
    <tr>

        <td>
            <div style="display: flex; background: #FAFAFA">
                <img src="../img/logo.png" width="160px" height="80px" style="cursor: pointer">

                <div style="display: block; line-height: 80px">
                    <span style="font-size: 2em; color: #F44336; margin-left: 20px"><b>图集</b></span>
                    <span class="nav-title" onclick="window.open('./tag-management.html');">标签管理</span>
                    <span class="nav-title" onclick="window.open('./res-management.html');">资源管理</span>
                    <span class="nav-title" onclick="window.open('./index.html');">视频</span>
                </div>
            </div>
        </td>
    </tr>
    <tr>
        <td>
            <div id="album-list" style="position: relative;"></div>
        </td>
    </tr>
    <tr>
        <td align="center">
            <div style="position: relative;" id="page-controller"></div>
        </td>
    </tr>
</table>
</body>

<script>

    var COUNT_PER_PAGE = 5;
    var albumList = [];
    var currentPageNumber = 0;

    function loadImageAlbums() {
        $.ajax({
            crossDomain: true,
            url: "http://localhost:8880/information",
            data: {type: "image-album-list"},
            method: "GET",
            dataType: "json",
            success: function (data) {
                if (data.code == 0 && data.data != null) {
                    albumList = data.data.albums;
                    currentPageNumber = 0;
                    console.log(albumList)
                    updateImageAlbums()
                }
            }
        });
    }

    // function loadPreviousPage() {
    //     loadPage(currentPageNumber - 1);
    // }
    //
    // function loadNextPage() {
    //     loadPage(currentPageNumber + 1);
    // }

    function loadPage(page) {
        currentPageNumber = page;
        updateImageAlbums();
        window.scrollTo(0, 0);
    }

    function updateImageAlbums() {

        var div = "";
        for (var i = currentPageNumber * COUNT_PER_PAGE; i < albumList.length && i < currentPageNumber * COUNT_PER_PAGE + COUNT_PER_PAGE; i++) {
            var imageCount = albumList[i].count;
            var extension = albumList[i].extension;
            var baseIndex = albumList[i].base_index;

            var images = [];
            for (var j = 0; j < 30; j++) {
                var randomIndex = Math.floor((Math.random() * imageCount));
                images[images.length] = albumList[i].path + (baseIndex + randomIndex) + "." + extension;
            }

            div = div + getAlbumDiv(i, images, imageCount, albumList[i].name);
        }

        document.getElementById("album-list").innerHTML = div;
        document.getElementById("page-controller").innerHTML = getPageControllerDiv(albumList.length, COUNT_PER_PAGE, loadPage, currentPageNumber, 'album-list');
    }
</script>

<script>

    loadImageAlbums();
</script>
</html>